# Functionbeat

The Lambdas that do the log shipment run [Functionbeat](https://www.elastic.co/beats/functionbeat), created by Elastic.

Functionbeat manages its own infrastructure and application logic to run the shippers. It leverages [AWS CloudFormation](https://aws.amazon.com/cloudformation/) to manage the stack to run on.

Infrastructure created by FunctionBeat (CloudFormation), and not Terraform includes:

1. S3 bucket to host the application
2. Lambdas
3. IAM policies  

## Configuration

Functionbeat is configured with a [YAML file](https://www.elastic.co/guide/en/beats/functionbeat/6.8/functionbeat-configuration.html), which defines which functions should be run and which data sources they depend on.

This file is dynamically generated by Terraform and injects references to the infrastructure that was created.

At the time of development, FunctionBeat was unable to do cross-account AWS deployments using the binary provided.
The CloudFormation stack creation had to be reproduced in the buildspec.yml file.

### Concurrency limits

There is an account limit of 1000 concurrent Lambda executions. We have 3 Lambdas with the concurrency limit set to 100, taking 300 of the allowed 1000 concurrent executions. The service is not currently utilising all 300 concurrent executions. If this threshold was crossed, CloudWatch alarms would go off. This account limit can be [increased](https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-limits.html) if need be.

### Timeouts

Functions time out after 8 seconds of being unable to ship a log message. If sending a log message has timed out, it will be placed on the Dead Letter Queue.

### Data sources

Functionbeat has been configured to monitor 3 data sources:

  1. CloudWatch
  2. Kinesis
  3. SQS

### Decoding

Functionbeat JSON decodes strings where possible. This is required to effectively navigate logs in Grafana on the remote platform.

### Tagging

Each one of the data sources mentioned above are annotated with a `log_source` tag.  Some other metadata that is added is the environment (Development, Pre-production, Production), and the Cloud provider, in this case AWS.
